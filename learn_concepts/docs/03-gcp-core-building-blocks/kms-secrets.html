<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kms Secrets</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <link rel="stylesheet" href="../../assets/styles.css">
</head>
<body class="antialiased">
    <header class="bg-white sticky top-0 z-50 shadow-md">
        <nav class="container mx-auto px-4 sm:px-6 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                                <button class="sidebar-toggle mobile md:hidden" id="sidebarToggleMobile" aria-label="Toggle sidebar">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
                <button class="sidebar-toggle desktop hidden md:block" id="sidebarToggleDesktop" aria-label="Toggle sidebar">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
                <div class="text-xl sm:text-2xl font-bold text-gray-800">
                    <a href="../../../index.html" class="flex items-center">
                        <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
                        <span class="gradient-text">Home</span>
                    </a>
                </div>
            </div>
            <ul class="flex space-x-4 sm:space-x-6 text-gray-600 font-medium text-sm sm:text-base">
                <li><a href="../../../case_studies.html" class="hover:text-[#bc5090] font-semibold">Case Studies</a></li>
                <li><a href="../../../aboutme.html" class="hover:text-[#bc5090] font-semibold">About Me</a></li>
            </ul>
        </nav>
    </header>
        <div class="sidebar-overlay" id="sidebarOverlay"></div>
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">Table of Contents</div>
            <button class="sidebar-close" id="sidebarClose" aria-label="Close sidebar">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div class="sidebar-content">
            <ul class="sidebar-nav">
                <li><a href="#cloud-kms-secret-management" class="level-1">Cloud KMS &amp; Secret Management</a></li>
                <li><a href="#mental-model" class="level-2">Mental Model</a></li>
                <li><a href="#key-management-architecture" class="level-3">Key Management Architecture</a></li>
                <li><a href="#encryption-model" class="level-3">Encryption Model</a></li>
                <li><a href="#internals-architecture" class="level-2">Internals &amp; Architecture</a></li>
                <li><a href="#cloud-kms" class="level-3">Cloud KMS</a></li>
                <li><a href="#key-hierarchy" class="level-4">Key Hierarchy</a></li>
                <li><a href="#key-types" class="level-4">Key Types</a></li>
                <li><a href="#key-versions" class="level-4">Key Versions</a></li>
                <li><a href="#hardware-security-module-hsm" class="level-4">Hardware Security Module (HSM)</a></li>
                <li><a href="#secret-manager" class="level-3">Secret Manager</a></li>
                <li><a href="#secret-storage" class="level-4">Secret Storage</a></li>
                <li><a href="#secret-access" class="level-4">Secret Access</a></li>
                <li><a href="#envelope-encryption" class="level-3">Envelope Encryption</a></li>
                <li><a href="#process" class="level-4">Process</a></li>
                <li><a href="#benefits" class="level-4">Benefits</a></li>
                <li><a href="#key-rotation" class="level-3">Key Rotation</a></li>
                <li><a href="#automatic-rotation" class="level-4">Automatic Rotation</a></li>
                <li><a href="#manual-rotation" class="level-4">Manual Rotation</a></li>
                <li><a href="#performance-characteristics" class="level-3">Performance Characteristics</a></li>
                <li><a href="#latency" class="level-4">Latency</a></li>
                <li><a href="#throughput" class="level-4">Throughput</a></li>
                <li><a href="#failure-modes-blast-radius" class="level-2">Failure Modes &amp; Blast Radius</a></li>
                <li><a href="#kms-failures" class="level-3">KMS Failures</a></li>
                <li><a href="#scenario-1-service-outage" class="level-4">Scenario 1: Service Outage</a></li>
                <li><a href="#scenario-2-key-unavailable" class="level-4">Scenario 2: Key Unavailable</a></li>
                <li><a href="#scenario-3-key-compromise" class="level-4">Scenario 3: Key Compromise</a></li>
                <li><a href="#secret-manager-failures" class="level-3">Secret Manager Failures</a></li>
                <li><a href="#scenario-1-secret-unavailable" class="level-4">Scenario 1: Secret Unavailable</a></li>
                <li><a href="#scenario-2-secret-leakage" class="level-4">Scenario 2: Secret Leakage</a></li>
                <li><a href="#performance-failures" class="level-3">Performance Failures</a></li>
                <li><a href="#scenario-1-high-latency" class="level-4">Scenario 1: High Latency</a></li>
                <li><a href="#overload-scenarios" class="level-3">Overload Scenarios</a></li>
                <li><a href="#10-normal-load" class="level-4">10× Normal Load</a></li>
                <li><a href="#100-normal-load" class="level-4">100× Normal Load</a></li>
                <li><a href="#observability-contract" class="level-2">Observability Contract</a></li>
                <li><a href="#metrics-to-track" class="level-3">Metrics to Track</a></li>
                <li><a href="#kms-metrics" class="level-4">KMS Metrics</a></li>
                <li><a href="#secret-manager-metrics" class="level-4">Secret Manager Metrics</a></li>
                <li><a href="#logs" class="level-3">Logs</a></li>
                <li><a href="#alerts" class="level-3">Alerts</a></li>
                <li><a href="#change-safety" class="level-2">Change Safety</a></li>
                <li><a href="#key-changes" class="level-3">Key Changes</a></li>
                <li><a href="#creating-keys" class="level-4">Creating Keys</a></li>
                <li><a href="#rotating-keys" class="level-4">Rotating Keys</a></li>
                <li><a href="#destroying-keys" class="level-4">Destroying Keys</a></li>
                <li><a href="#secret-changes" class="level-3">Secret Changes</a></li>
                <li><a href="#creating-secrets" class="level-4">Creating Secrets</a></li>
                <li><a href="#updating-secrets" class="level-4">Updating Secrets</a></li>
                <li><a href="#rotating-secrets" class="level-4">Rotating Secrets</a></li>
                <li><a href="#security-boundaries" class="level-2">Security Boundaries</a></li>
                <li><a href="#access-control" class="level-3">Access Control</a></li>
                <li><a href="#encryption" class="level-3">Encryption</a></li>
                <li><a href="#key-protection" class="level-3">Key Protection</a></li>
                <li><a href="#tradeoffs" class="level-2">Tradeoffs</a></li>
                <li><a href="#key-storage-software-vs-hardware-hsm" class="level-3">Key Storage: Software vs Hardware HSM</a></li>
                <li><a href="#key-rotation-automatic-vs-manual" class="level-3">Key Rotation: Automatic vs Manual</a></li>
                <li><a href="#envelope-encryption-performance-vs-security" class="level-3">Envelope Encryption: Performance vs Security</a></li>
                <li><a href="#operational-considerations" class="level-2">Operational Considerations</a></li>
                <li><a href="#capacity-planning" class="level-3">Capacity Planning</a></li>
                <li><a href="#monitoring-debugging" class="level-3">Monitoring &amp; Debugging</a></li>
                <li><a href="#incident-response" class="level-3">Incident Response</a></li>
                <li><a href="#what-staff-engineers-ask-in-reviews" class="level-2">What Staff Engineers Ask in Reviews</a></li>
                <li><a href="#design-questions" class="level-3">Design Questions</a></li>
                <li><a href="#security-questions" class="level-3">Security Questions</a></li>
                <li><a href="#operational-questions" class="level-3">Operational Questions</a></li>
                <li><a href="#further-reading" class="level-2">Further Reading</a></li>
                <li><a href="#exercises" class="level-2">Exercises</a></li>
            </ul>
        </div>
    </aside>
    <main class="main-content container mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="content">
<h1 id="cloud-kms-secret-management">Cloud KMS &amp; Secret Management</h1>
<p><strong>One-line summary</strong>: Deep dive into Cloud KMS key management, Secret Manager, envelope encryption, and how to design secure key and secret management.</p>
<p><strong>Prerequisites</strong>: <a href="iam-evaluation.html">IAM Evaluation Model</a>, Basic cryptography concepts (encryption, keys, secrets).</p>
<hr />
<h2 id="mental-model">Mental Model</h2>
<h3 id="key-management-architecture">Key Management Architecture</h3>
<div class="mermaid">
flowchart TB
App[Application] --> SM[Secret Manager]
App --> KMS[Cloud KMS]
SM --> KMSKey[KMS Key<br/>Encryption]
KMS --> KMSKey
KMSKey --> HSM[Hardware Security Module<br/>HSM]
App --> DataKey[Data Encryption Key<br/>DEK]
DataKey --> KMSKey
style SM fill:#99ccff
style KMS fill:#ffcc99
style HSM fill:#99ff99
</div>
<p><strong>Key insight</strong>: Cloud KMS manages encryption keys, while Secret Manager stores secrets encrypted with KMS keys. Understanding envelope encryption and key rotation is critical for security.</p>
<h3 id="encryption-model">Encryption Model</h3>
<p><strong>Envelope Encryption</strong>: Encrypt data with data encryption key (DEK), encrypt DEK with key encryption key (KEK).</p>
<p><strong>Components</strong>:
- <strong>KEK</strong>: Key Encryption Key (managed by KMS)
- <strong>DEK</strong>: Data Encryption Key (used to encrypt data)
- <strong>Ciphertext</strong>: Encrypted data + encrypted DEK</p>
<p><strong>Benefits</strong>:
- <strong>Performance</strong>: Encrypt/decrypt data with DEK (fast)
- <strong>Security</strong>: Protect DEK with KEK (secure)
- <strong>Rotation</strong>: Rotate KEK without re-encrypting data</p>
<hr />
<h2 id="internals-architecture">Internals &amp; Architecture</h2>
<h3 id="cloud-kms">Cloud KMS</h3>
<h4 id="key-hierarchy">Key Hierarchy</h4>
<p><strong>Key Ring</strong>: Container for keys (regional).</p>
<p><strong>Key</strong>: Encryption key (symmetric or asymmetric).</p>
<p><strong>Key Version</strong>: Version of key (for rotation).</p>
<p><strong>Structure</strong>:</p>
<pre><code>Project
  └── Key Ring (us-central1)
      └── Key (my-key)
          ├── Version 1 (primary)
          ├── Version 2
          └── Version 3
</code></pre>
<h4 id="key-types">Key Types</h4>
<p><strong>Symmetric Keys</strong>: Same key for encryption and decryption.
- <strong>Use case</strong>: Encrypt data, encrypt DEKs
- <strong>Algorithm</strong>: AES-256
- <strong>Performance</strong>: Fast encryption/decryption</p>
<p><strong>Asymmetric Keys</strong>: Different keys for encryption and decryption.
- <strong>Use case</strong>: Signing, encryption
- <strong>Algorithm</strong>: RSA, EC
- <strong>Performance</strong>: Slower than symmetric</p>
<h4 id="key-versions">Key Versions</h4>
<p><strong>Versions</strong>: Multiple versions of same key.</p>
<p><strong>Primary version</strong>: Active version for encryption.</p>
<p><strong>Use cases</strong>:
- <strong>Rotation</strong>: Rotate keys without downtime
- <strong>Rollback</strong>: Rollback to previous version if needed
- <strong>Audit</strong>: Track key usage per version</p>
<h4 id="hardware-security-module-hsm">Hardware Security Module (HSM)</h4>
<p><strong>HSM</strong>: Hardware security module for key storage.</p>
<p><strong>Types</strong>:
- <strong>Software</strong>: Software-based HSM (default)
- <strong>Hardware</strong>: Hardware-based HSM (Cloud HSM)</p>
<p><strong>Benefits</strong>:
- <strong>Security</strong>: Keys never leave HSM
- <strong>Compliance</strong>: Meet compliance requirements
- <strong>Performance</strong>: Hardware acceleration</p>
<h3 id="secret-manager">Secret Manager</h3>
<h4 id="secret-storage">Secret Storage</h4>
<p><strong>Secrets</strong>: Sensitive data (passwords, API keys, certificates).</p>
<p><strong>Storage</strong>: Encrypted at rest with KMS keys.</p>
<p><strong>Access</strong>: Access via IAM policies.</p>
<p><strong>Versioning</strong>: Multiple versions of secrets.</p>
<h4 id="secret-access">Secret Access</h4>
<p><strong>Access patterns</strong>:
- <strong>Application</strong>: Applications access secrets via API
- <strong>IAM</strong>: IAM policies control access
- <strong>Audit</strong>: All access logged</p>
<p><strong>Best practices</strong>:
- <strong>Least privilege</strong>: Grant minimum necessary access
- <strong>Rotation</strong>: Rotate secrets regularly
- <strong>Monitoring</strong>: Monitor secret access</p>
<h3 id="envelope-encryption">Envelope Encryption</h3>
<h4 id="process">Process</h4>
<p><strong>Encryption</strong>:
1. <strong>Generate DEK</strong>: Generate data encryption key
2. <strong>Encrypt data</strong>: Encrypt data with DEK
3. <strong>Encrypt DEK</strong>: Encrypt DEK with KEK (KMS)
4. <strong>Store</strong>: Store encrypted data + encrypted DEK</p>
<p><strong>Decryption</strong>:
1. <strong>Retrieve</strong>: Retrieve encrypted data + encrypted DEK
2. <strong>Decrypt DEK</strong>: Decrypt DEK with KEK (KMS)
3. <strong>Decrypt data</strong>: Decrypt data with DEK
4. <strong>Return</strong>: Return decrypted data</p>
<h4 id="benefits">Benefits</h4>
<p><strong>Performance</strong>: Encrypt/decrypt data with DEK (fast, local).</p>
<p><strong>Security</strong>: Protect DEK with KEK (secure, KMS).</p>
<p><strong>Rotation</strong>: Rotate KEK without re-encrypting data (only re-encrypt DEK).</p>
<h3 id="key-rotation">Key Rotation</h3>
<h4 id="automatic-rotation">Automatic Rotation</h4>
<p><strong>Automatic rotation</strong>: KMS automatically rotates keys.</p>
<p><strong>Configuration</strong>:
- <strong>Rotation period</strong>: How often to rotate (e.g., 90 days)
- <strong>Rotation schedule</strong>: When to rotate</p>
<p><strong>Process</strong>:
1. <strong>Generate</strong>: Generate new key version
2. <strong>Promote</strong>: Promote new version to primary
3. <strong>Deprecate</strong>: Deprecate old versions
4. <strong>Destroy</strong>: Destroy old versions after grace period</p>
<h4 id="manual-rotation">Manual Rotation</h4>
<p><strong>Manual rotation</strong>: Manually rotate keys.</p>
<p><strong>Process</strong>:
1. <strong>Create</strong>: Create new key version
2. <strong>Promote</strong>: Promote new version to primary
3. <strong>Re-encrypt</strong>: Re-encrypt data with new key (if needed)
4. <strong>Deprecate</strong>: Deprecate old versions
5. <strong>Destroy</strong>: Destroy old versions</p>
<h3 id="performance-characteristics">Performance Characteristics</h3>
<h4 id="latency">Latency</h4>
<p><strong>KMS operations</strong>:
- <strong>Encrypt</strong>: P95 &lt; 100ms
- <strong>Decrypt</strong>: P95 &lt; 100ms
- <strong>Sign</strong>: P95 &lt; 100ms
- <strong>Verify</strong>: P95 &lt; 100ms</p>
<p><strong>Secret Manager</strong>:
- <strong>Access</strong>: P95 &lt; 100ms
- <strong>Factors</strong>: Network latency, KMS latency</p>
<h4 id="throughput">Throughput</h4>
<p><strong>KMS throughput</strong>:
- <strong>Operations</strong>: Thousands of operations per second
- <strong>Scaling</strong>: Scales with key usage</p>
<p><strong>Secret Manager throughput</strong>:
- <strong>Access</strong>: Thousands of accesses per second
- <strong>Scaling</strong>: Scales with usage</p>
<hr />
<h2 id="failure-modes-blast-radius">Failure Modes &amp; Blast Radius</h2>
<h3 id="kms-failures">KMS Failures</h3>
<h4 id="scenario-1-service-outage">Scenario 1: Service Outage</h4>
<ul>
<li><strong>Impact</strong>: Cannot encrypt/decrypt, applications fail</li>
<li><strong>Blast radius</strong>: All applications using KMS</li>
<li><strong>Detection</strong>: KMS API errors, encryption failures</li>
<li><strong>Recovery</strong>: Service automatically recovers</li>
<li><strong>Mitigation</strong>: GCP managed service (high availability)</li>
</ul>
<h4 id="scenario-2-key-unavailable">Scenario 2: Key Unavailable</h4>
<ul>
<li><strong>Impact</strong>: Cannot encrypt/decrypt with key, applications fail</li>
<li><strong>Blast radius</strong>: Applications using affected key</li>
<li><strong>Detection</strong>: Key access errors, encryption failures</li>
<li><strong>Recovery</strong>: </li>
<li>Restore key from backup</li>
<li>Use key version (if available)</li>
<li>Recreate key (if needed)</li>
<li><strong>Mitigation</strong>: </li>
<li>Key backups</li>
<li>Multiple key versions</li>
<li>Key replication</li>
</ul>
<h4 id="scenario-3-key-compromise">Scenario 3: Key Compromise</h4>
<ul>
<li><strong>Impact</strong>: Key compromised, data at risk</li>
<li><strong>Blast radius</strong>: All data encrypted with key</li>
<li><strong>Detection</strong>: Unusual access patterns, security alerts</li>
<li><strong>Recovery</strong>: </li>
<li>Rotate key immediately</li>
<li>Re-encrypt data with new key</li>
<li>Investigate compromise</li>
<li><strong>Mitigation</strong>: </li>
<li>Key rotation</li>
<li>Access monitoring</li>
<li>Security alerts</li>
</ul>
<h3 id="secret-manager-failures">Secret Manager Failures</h3>
<h4 id="scenario-1-secret-unavailable">Scenario 1: Secret Unavailable</h4>
<ul>
<li><strong>Impact</strong>: Cannot access secrets, applications fail</li>
<li><strong>Blast radius</strong>: Applications using affected secrets</li>
<li><strong>Detection</strong>: Secret access errors, application failures</li>
<li><strong>Recovery</strong>: </li>
<li>Restore secret from backup</li>
<li>Use secret version (if available)</li>
<li>Recreate secret (if needed)</li>
<li><strong>Mitigation</strong>: </li>
<li>Secret backups</li>
<li>Multiple secret versions</li>
<li>Secret replication</li>
</ul>
<h4 id="scenario-2-secret-leakage">Scenario 2: Secret Leakage</h4>
<ul>
<li><strong>Impact</strong>: Secret leaked, security risk</li>
<li><strong>Blast radius</strong>: Affected secret and applications</li>
<li><strong>Detection</strong>: Unusual access patterns, security alerts</li>
<li><strong>Recovery</strong>: </li>
<li>Rotate secret immediately</li>
<li>Update applications with new secret</li>
<li>Investigate leakage</li>
<li><strong>Mitigation</strong>: </li>
<li>Secret rotation</li>
<li>Access monitoring</li>
<li>Security alerts</li>
</ul>
<h3 id="performance-failures">Performance Failures</h3>
<h4 id="scenario-1-high-latency">Scenario 1: High Latency</h4>
<ul>
<li><strong>Impact</strong>: Slow encryption/decryption, application latency</li>
<li><strong>Blast radius</strong>: Applications using KMS/Secret Manager</li>
<li><strong>Detection</strong>: High latency metrics</li>
<li><strong>Recovery</strong>: </li>
<li>Check KMS/Secret Manager health</li>
<li>Optimize usage patterns</li>
<li>Scale if needed</li>
<li><strong>Mitigation</strong>: </li>
<li>Monitor latency</li>
<li>Optimize usage</li>
<li>Use caching if appropriate</li>
</ul>
<h3 id="overload-scenarios">Overload Scenarios</h3>
<h4 id="10-normal-load">10× Normal Load</h4>
<ul>
<li><strong>Latency</strong>: May increase, operations may queue</li>
<li><strong>Throughput</strong>: Handles load, may need scaling</li>
<li><strong>Availability</strong>: Maintains availability</li>
</ul>
<h4 id="100-normal-load">100× Normal Load</h4>
<ul>
<li><strong>Latency</strong>: Significantly increased, operations queue</li>
<li><strong>Throughput</strong>: May need significant scaling</li>
<li><strong>Availability</strong>: Maintains availability, but latency high</li>
</ul>
<hr />
<h2 id="observability-contract">Observability Contract</h2>
<h3 id="metrics-to-track">Metrics to Track</h3>
<h4 id="kms-metrics">KMS Metrics</h4>
<ul>
<li><strong>Operation rate</strong>: Encrypt/decrypt operations per second</li>
<li><strong>Operation latency</strong>: Operation latency (P50/P95/P99)</li>
<li><strong>Error rate</strong>: Error rate</li>
<li><strong>Key usage</strong>: Key usage per key</li>
</ul>
<h4 id="secret-manager-metrics">Secret Manager Metrics</h4>
<ul>
<li><strong>Access rate</strong>: Secret accesses per second</li>
<li><strong>Access latency</strong>: Access latency (P50/P95/P99)</li>
<li><strong>Error rate</strong>: Error rate</li>
<li><strong>Secret usage</strong>: Secret usage per secret</li>
</ul>
<h3 id="logs">Logs</h3>
<p><strong>KMS logs</strong>:
- Key operations (encrypt, decrypt, sign, verify)
- Key access
- Admin activity logs
- Error logs</p>
<p><strong>Secret Manager logs</strong>:
- Secret access
- Admin activity logs
- Error logs</p>
<h3 id="alerts">Alerts</h3>
<p><strong>Critical alerts</strong>:
- Service unavailable
- Key unavailable
- Secret unavailable
- High error rate (&gt; 1%)</p>
<p><strong>Warning alerts</strong>:
- High latency
- Unusual access patterns
- Key rotation due
- Secret rotation due</p>
<hr />
<h2 id="change-safety">Change Safety</h2>
<h3 id="key-changes">Key Changes</h3>
<h4 id="creating-keys">Creating Keys</h4>
<ul>
<li><strong>Process</strong>: Create key, configure settings</li>
<li><strong>Risk</strong>: Low (additive change)</li>
<li><strong>Rollback</strong>: Delete key (if not used)</li>
</ul>
<h4 id="rotating-keys">Rotating Keys</h4>
<ul>
<li><strong>Process</strong>: Create new version, promote to primary</li>
<li><strong>Risk</strong>: Medium (may affect applications)</li>
<li><strong>Rollback</strong>: Revert to previous version</li>
</ul>
<h4 id="destroying-keys">Destroying Keys</h4>
<ul>
<li><strong>Process</strong>: Destroy key version</li>
<li><strong>Risk</strong>: High (irreversible, data loss)</li>
<li><strong>Rollback</strong>: Cannot rollback (irreversible)</li>
</ul>
<h3 id="secret-changes">Secret Changes</h3>
<h4 id="creating-secrets">Creating Secrets</h4>
<ul>
<li><strong>Process</strong>: Create secret, store value</li>
<li><strong>Risk</strong>: Low (additive change)</li>
<li><strong>Rollback</strong>: Delete secret</li>
</ul>
<h4 id="updating-secrets">Updating Secrets</h4>
<ul>
<li><strong>Process</strong>: Create new version, update applications</li>
<li><strong>Risk</strong>: Medium (may break applications)</li>
<li><strong>Rollback</strong>: Revert to previous version</li>
</ul>
<h4 id="rotating-secrets">Rotating Secrets</h4>
<ul>
<li><strong>Process</strong>: Create new version, update applications, deprecate old</li>
<li><strong>Risk</strong>: Medium (may break applications)</li>
<li><strong>Rollback</strong>: Revert to previous version</li>
</ul>
<hr />
<h2 id="security-boundaries">Security Boundaries</h2>
<h3 id="access-control">Access Control</h3>
<ul>
<li><strong>IAM</strong>: Key and secret-level IAM policies</li>
<li><strong>Service accounts</strong>: Use service accounts for applications</li>
<li><strong>VPC</strong>: VPC Service Controls for network isolation</li>
</ul>
<h3 id="encryption">Encryption</h3>
<p><strong>At rest</strong>:
- <strong>KMS keys</strong>: Stored in HSM (hardware security)
- <strong>Secrets</strong>: Encrypted with KMS keys</p>
<p><strong>In transit</strong>:
- <strong>TLS</strong>: All connections use TLS
- <strong>Encryption</strong>: Data encrypted in transit</p>
<h3 id="key-protection">Key Protection</h3>
<ul>
<li><strong>HSM</strong>: Keys stored in HSM (never leave HSM)</li>
<li><strong>Access control</strong>: IAM policies control key access</li>
<li><strong>Audit</strong>: All key operations logged</li>
</ul>
<hr />
<h2 id="tradeoffs">Tradeoffs</h2>
<h3 id="key-storage-software-vs-hardware-hsm">Key Storage: Software vs Hardware HSM</h3>
<p><strong>Software HSM</strong>:
- <strong>Pros</strong>: Lower cost, easier to use
- <strong>Cons</strong>: Less secure than hardware</p>
<p><strong>Hardware HSM</strong>:
- <strong>Pros</strong>: More secure, compliance
- <strong>Cons</strong>: Higher cost, more complex</p>
<h3 id="key-rotation-automatic-vs-manual">Key Rotation: Automatic vs Manual</h3>
<p><strong>Automatic</strong>:
- <strong>Pros</strong>: No manual intervention, consistent
- <strong>Cons</strong>: Less control, may cause issues</p>
<p><strong>Manual</strong>:
- <strong>Pros</strong>: More control, can plan
- <strong>Cons</strong>: Manual work, may forget</p>
<h3 id="envelope-encryption-performance-vs-security">Envelope Encryption: Performance vs Security</h3>
<p><strong>Envelope encryption</strong>:
- <strong>Pros</strong>: Better performance, secure
- <strong>Cons</strong>: More complex</p>
<p><strong>Direct encryption</strong>:
- <strong>Pros</strong>: Simpler
- <strong>Cons</strong>: Slower, less secure</p>
<hr />
<h2 id="operational-considerations">Operational Considerations</h2>
<h3 id="capacity-planning">Capacity Planning</h3>
<p><strong>KMS</strong>:
- <strong>Keys</strong>: Plan for number of keys
- <strong>Operations</strong>: Plan for operation rate
- <strong>Scaling</strong>: Plan for scaling</p>
<p><strong>Secret Manager</strong>:
- <strong>Secrets</strong>: Plan for number of secrets
- <strong>Access</strong>: Plan for access rate
- <strong>Scaling</strong>: Plan for scaling</p>
<h3 id="monitoring-debugging">Monitoring &amp; Debugging</h3>
<p><strong>Monitor</strong>:
- Key/secret usage
- Operation latency
- Error rates
- Access patterns</p>
<p><strong>Debug issues</strong>:
1. Check KMS/Secret Manager health
2. Check key/secret access
3. Check IAM policies
4. Check error logs
5. Review access logs</p>
<h3 id="incident-response">Incident Response</h3>
<p><strong>Common incidents</strong>:
- Key unavailable
- Secret unavailable
- High latency
- Security alerts</p>
<p><strong>Response</strong>:
1. Check service health
2. Check key/secret access
3. Check IAM policies
4. Rotate keys/secrets if compromised
5. Contact support if persistent</p>
<hr />
<h2 id="what-staff-engineers-ask-in-reviews">What Staff Engineers Ask in Reviews</h2>
<h3 id="design-questions">Design Questions</h3>
<ul>
<li>"What's the key management strategy?"</li>
<li>"How are secrets stored?"</li>
<li>"What's the encryption model?"</li>
<li>"How is key rotation handled?"</li>
</ul>
<h3 id="security-questions">Security Questions</h3>
<ul>
<li>"How are keys protected?"</li>
<li>"What's the access control?"</li>
<li>"How are secrets rotated?"</li>
<li>"What's the audit strategy?"</li>
</ul>
<h3 id="operational-questions">Operational Questions</h3>
<ul>
<li>"How do you monitor KMS/Secret Manager?"</li>
<li>"What alerts do you have?"</li>
<li>"How do you debug key/secret issues?"</li>
<li>"What's the rotation strategy?"</li>
</ul>
<hr />
<h2 id="further-reading">Further Reading</h2>
<p><strong>Comprehensive Guide</strong>: <a href="../further-reading/kms-secrets.html">Further Reading: KMS &amp; Secrets</a></p>
<p><strong>Quick Links</strong>:
- <a href="https://cloud.google.com/kms/docs">Cloud KMS Documentation</a>
- <a href="https://cloud.google.com/secret-manager/docs">Secret Manager Documentation</a>
- <a href="https://cloud.google.com/kms/docs/envelope-encryption">Envelope Encryption</a>
- <a href="https://cloud.google.com/kms/docs/key-rotation">Key Rotation</a>
- <a href="README.html">Back to GCP Core Building Blocks</a></p>
<hr />
<h2 id="exercises">Exercises</h2>
<ol>
<li>
<p><strong>Design key management</strong>: Design a key management strategy for a multi-tenant application. What keys? How is rotation handled?</p>
</li>
<li>
<p><strong>Handle key compromise</strong>: A key is compromised. How do you respond? What's the recovery strategy?</p>
</li>
<li>
<p><strong>Optimize performance</strong>: Your application has high KMS latency. How do you optimize it? What's the strategy?</p>
</li>
</ol>
<p><strong>Answer Key</strong>: <a href="../exercises/answers/kms-secrets-answers.html">View Answers</a></p>
        </div>
    </main>
    <footer class="bg-gray-800 text-white text-center p-6 mt-16">
        <p>&copy; 2025 Data Engineering Guides. An illustrative web application.</p>
    </footer>
    <script src="../../assets/scripts.js"></script>
    
</body>
</html>
